<powershell>
# Set up WinRM for Packer
write-output "Running User Data Script"
write-host "(host) Running User Data Script"

Set-ExecutionPolicy Unrestricted -Scope LocalMachine -Force -ErrorAction Ignore

# Don't set this if you want to keep the password random, 
# but for Packer we usually set a known password or use the keypair 
# handling. Here we rely on Packer generating a password.

# Configure WinRM
cmd.exe /c winrm quickconfig -q
cmd.exe /c winrm set winrm/config/service @{AllowUnencrypted="true"}
cmd.exe /c winrm set winrm/config/service/auth @{Basic="true"}

# Make sure firewall allows WinRM
netsh advfirewall firewall set rule group="Windows Remote Management" new enable=yes

# Create a tag file so we know user data finished
New-Item -Path C:\ -Name "userdata_executed.txt" -ItemType "file"
</powershell>